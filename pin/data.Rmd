---
title: "Data cleaning and summarization for HDL lipidomics of Ghana samples"
output: html_notebook
editor_options: 
  chunk_output_type: inline
author: Chenghao Zhu
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r, message=FALSE, warning=FALSE}
pkgs = c("dplyr", "reshape2", "stringr", "Metabase", "xlsx", "tibble")
for(pkg in pkgs){
    library(pkg, quietly=TRUE, verbose=FALSE, warn.conflicts=FALSE, 
            character.only=TRUE)
}
```

# Part 1: read and clean data

Because the positive mode and negative mode data are in separate sheets, so they were first imported in to 2 separate objects, to be merged later.

```{r}
pos = import_wcmc_excel(
    file = "../raw_data/MX388497_Zhu_CSH_Submit.xlsx",
    sheet = "Positive Submit",
    conc_range = "K8:DB1742",
    sample_range = "J1:DB7",
    feature_range = "A7:J1742",
    InChIKey = "InChI Key",
    experiment_type = "Lipidomcis"
)
neg = import_wcmc_excel(
    file = "../raw_data/MX388497_Zhu_CSH_Submit.xlsx",
    sheet = "Negative Submit",
    conc_range = "K8:DD610",
    sample_range = "J1:DD7",
    feature_range = "A7:J610",
    InChIKey = "InChI Key",
    experiment_type = "Lipidomics"
)
```

Remove all the features that are unknown, then calculate the mean, standards deviation, and coefficient of variance of the qc samples, and merge the two objects into one.

```{r, warning=FALSE}
pos = subset_features(pos, !is.na(pos$feature_data$InChIKey))
neg = subset_features(neg, !is.na(neg$feature_data$InChIKey))

pos = collapse_QC(pos, qc_names = paste0("Biorec00", 1:8))
neg = collapse_QC(neg, qc_names = paste0("Biorec00", 1:9))

pos = subset_samples(pos, !grepl("^MtdBlnk", sampleNames(pos)))
neg = subset_samples(neg, !grepl("^MtdBlnk", sampleNames(neg)))

pos$feature_data$ESI = "pos"
neg$feature_data$ESI = "neg"

featureNames(pos) = paste0("pos", 1:nfeatures(pos))
featureNames(neg) = paste0("neg", 1:nfeatures(neg))

lpd = LipidomicsSet(
    conc_table = conc_table(rbind(pos$conc_table, neg$conc_table)),
    sample_table = pos$sample_table,
    feature_data = feature_data(rbind(pos$feature_data, neg$feature_data)),
    experiment_data = pos$experiment_data
)
```

Missing values.

The figure belows shows the missing values in the dataset. There is 1 feature that is only detected in one sample (39 NAs), 1 feature with 24 NAs, 1 feature with 13 features, and some with 1, 2, or 3 NAs. So I decided to remove the features with more than 10 NAs. And for the features with 1, 2, or 3 NAs, the missing values were filled up by 1/2 of the lowerest value detected across all samples.

```{r, warning = FALSE}
plot_hist_NA(lpd)
```

```{r}
lpd = subset_features(
    lpd, apply(conc_table(lpd), 1, function(x) sum(is.na(x)) < 10) )
lpd = transform_by_feature(
    lpd, function(x) ifelse(is.na(x), min(x, na.rm = TRUE)/2, x)
)
plot_hist_NA(lpd)
```

Read the internal standards and calibrate lipid species. The 3 PI species were removed because a PI interna standard was not ran.

```{r}
standards = read.csv("../raw_data/wcmc_lipidomics_standards.csv")
feature_data(lpd)$class = assign_lipid_class(feature_data(lpd)$Annotation)
experiment_data(lpd)$institute = "West Coast Metabolomics Center"
experiment_data(lpd)$sample_volumn_ul = 20
experiment_data(lpd)$internal_standards = standards
lpd = subset_features(
    lpd, !lpd$feature_data$class %in% c("CUDA", "PI", "AC"))

lpd = calibrate_lipidomics_wcmc(lpd, cid = "InChIKey", 
                                     class = "class", ESI = "ESI")
```

Some features were detected on both positive and negative mode. Only the one with a lower CV is kept.

```{r, warning=FALSE}
lpd = filter_by_cv(lpd, cv = "qc_cv", cid = "InChIKey")
lpd$feature_data$Annotation = lipid_name_formater(lpd$feature_data$Annotation)
lpd$feature_data$Annotation = make.unique(lpd$feature_data$Annotation)
featureNames(lpd) = lpd$feature_data$Annotation
lpd
```

The data has 313 lipid species and 80 samples.

Quality controls:

```{r}
plot_qc(lpd, mean = "qc_mean", sd = "qc_sd", cv = "qc_cv")
```

# Part 2: summarization

There is a huge variance of the sum of the total lipid species in each sample as shown below. There could be some biological variance, but technical variance contributes to a big part of it. So it is necessary to convert it to a relative proportion.

```{r}
barplot(apply(lpd$conc_table, 2, sum))
```

```{r}
lpd_prop = transform_by_sample(lpd, function(x) x/sum(x))
```

```{r}
barplot(apply(lpd_prop$conc_table, 2, sum))
```

Summarize lipid speceis into classes

```{r}
lpd_class = summarize_features(lpd_prop, "class")
```

```{r}
library(ggplot2, quietly = TRUE)
library(ggsci)
df = data.frame(
    class = featureNames(lpd_class),
    prop = rowMeans(lpd_class$conc_table),
    stringsAsFactors = F
) %>%
    mutate(class = str_c(class, ": ", round(prop*100,2), "%"))
set.seed(25)
color_pal = colorRampPalette(pal_npg()(10))(12)[sample(1:11)]
ggplot(df,aes(x=1, y=prop, fill = class)) +
    geom_bar(stat = "identity", color = "white")+
    coord_polar("y") + 
    scale_fill_manual(values = color_pal) +
    theme_bw() +
    theme(axis.line = element_blank(),
          panel.border = element_blank(),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank())
```

To calculate the equivalent of double bond and chain length, we need to first calculate the molecule weight of each lipid species.

```{r}
data("wcmc_adduct")
molwt = as.numeric(rep(NA, nfeatures(lpd)))
for(i in 1:nfeatures(lpd)){
    species = str_split(lpd$feature_data$Species[i], "\\_")[[1]]
    species = gsub("\\[", "", species)
    species = gsub("\\]", "", species)
    species = gsub("\\+$", "", species)
    species = gsub("\\-$", "", species)
    species = species[species %in% rownames(wcmc_adduct)]
    species = species[which.min(1 * wcmc_adduct[species,]$Mult + wcmc_adduct[species,]$Mass)]
    if(length(species) == 0) next
    mz = as.numeric(str_split(lpd$feature_data$`m/z`[i], "\\_")[[1]])
    mz = mz[which.min(mz)]
    molwt[i] = mz2molwt(species, mz)
}
lpd$feature_data$molwt = molwt
```

Calculate the equivalent of double bond (EOD), average chain length (ACL), odd chain lipids, and lipid class ratios.

```{r}
lpd_mol = transform_by_sample(lpd, function(x) x/molwt)
lpd_eod = summarize_EOD(lpd_mol, name = "Annotation", class = "class")
lpd_acl = summarize_ACL(lpd_mol, name = "Annotation", class = "class")
lpd_ratio = summarize_lipid_ratios(lpd_mol, name = "Annotation", class = "class")
lpd_ratio = subset_features(lpd_ratio, c("surface/core", "CE/Cholesterol", "PC/LPC", "CE/TG"))
featureNames(lpd_eod) = paste0("EOD ",featureNames(lpd_eod))
featureNames(lpd_acl) = paste0("ACL ",featureNames(lpd_acl))
```

The lipid class ratios calculated are: 

```{r}
featureNames(lpd_ratio)
```

# Part3: combine data and save as an excel spreadsheet

```{r}
primary = tibble(
    "surface/core" = lpd_ratio$conc_table["surface/core",],
    "EOD Overall" = lpd_eod$conc_table["EOD Overall",],
    "ACL Overall" = lpd_acl$conc_table["ACL Overall",]
) %>% as.data.frame
rownames(primary) = sampleNames(lpd)

li = list(lpd_class, lpd_prop, lpd_eod, lpd_acl, lpd_ratio)
mrg = function(li){
    if(length(li) == 1) return(t(li[[1]]$conc_table))
    else cbind(t(li[[1]]$conc_table), mrg(li[-1]))
}
exploratory = mrg(li) %>% as.tibble %>% as.data.frame
rownames(exploratory) = sampleNames(lpd)
exploratory = exploratory[, !colnames(exploratory) %in% colnames(primary)]

primary = rownames_to_column(primary, "sample_id")
exploratory = rownames_to_column(exploratory,"sample_id")

write.xlsx(primary, file = "gns_hdl_lipidomics_clean.xlsx", 
           sheetName = "Primary", row.names = FALSE)
write.xlsx(exploratory, file = "gns_hdl_lipidomics_clean.xlsx",
           sheetName = "Exploratory", append = TRUE, row.names = FALSE)
```

# Part 4: Session information

The Metabase is a pacakge that I made for high though-put experiments data, especially for metabolomics and lipidomics. For more information, please see the github repo at: [www.github.com/zhuchcn/Metabase](http://www.github.com/zhuchcn/Metabase)

```{r}
sessionInfo()
```